<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>活动宣传海报</title>
    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            background: linear-gradient(135deg, #4f46e5, #9333ea);
            font-family: 'Segoe UI', 'PingFang SC', Arial, sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .poster {
            width: min(480px, 90vw);
            background: #fff;
            border-radius: 24px;
            box-shadow: 0 25px 60px rgba(0,0,0,0.15);
            overflow: hidden;
            text-align: center;
            padding-bottom: 32px;
        }
        .poster-header {
            background: linear-gradient(135deg, #4f46e5, #9333ea);
            padding: 40px 20px 30px;
            color: #fff;
        }
        .poster-header h1 {
            margin: 0;
            font-size: 24px;
            line-height: 1.3;
        }
        .poster-header p {
            margin: 12px 0 0;
            font-size: 14px;
        }
        .poster-body {
            padding: 24px;
        }
        .info {
            margin: 12px 0;
            font-size: 14px;
            color: #444;
        }
        .qr-box {
            margin: 20px auto;
            width: 220px;
            height: 220px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #qr-code {
            width: 180px;
            height: 180px;
        }
        .status {
            margin-top: 12px;
            font-weight: bold;
            color: #c2410c;
        }
        .expired {
            color: #dc2626;
        }
    </style>
</head>
<body>
<div class="poster" id="poster">
    <div class="poster-header">
        <h1 id="poster-title">活动宣传海报</h1>
        <p id="poster-subtitle">扫码即可报名</p>
    </div>
    <div class="poster-body">
        <div class="info" id="poster-time">时间加载中...</div>
        <div class="info" id="poster-location">地点加载中...</div>
        <div class="info" id="poster-desc"></div>
        <div class="qr-box">
            <img id="qr-code" alt="报名二维码">
        </div>
        <div class="status" id="poster-status"></div>
    </div>
</div>

<script>
    const params = new URLSearchParams(window.location.search);
    const activityId = params.get('activityId');
    const posterTitle = document.getElementById('poster-title');
    const posterTime = document.getElementById('poster-time');
    const posterLocation = document.getElementById('poster-location');
    const posterDesc = document.getElementById('poster-desc');
    const posterStatus = document.getElementById('poster-status');
    const qrCodeImg = document.getElementById('qr-code');

    const STATUS_TEXT_MAP = {
        DRAFT: '未发布',
        OPEN: '报名中',
        CLOSED: '已截止',
        FINISHED: '已结束',
        DELETED: '已删除'
    };
    const LEGACY_STATUS_TO_CODE = {
        '未发布': 'DRAFT',
        '报名中': 'OPEN',
        '已截止': 'CLOSED',
        '已结束': 'FINISHED',
        '已删除': 'DELETED'
    };

    function normalizeStatus(status) {
        if (!status) return '';
        if (STATUS_TEXT_MAP[status]) return status;
        return LEGACY_STATUS_TO_CODE[status] || status;
    }

    if (!activityId) {
        posterTitle.textContent = '缺少活动信息';
        posterTime.textContent = '请通过正确的海报链接访问';
        posterLocation.textContent = '';
        posterDesc.textContent = '';
    } else {
        loadActivity();
    }

    async function loadActivity() {
        try {
            const res = await fetch('/activities/' + activityId);
            if (!res.ok) {
                posterTitle.textContent = '活动信息加载失败';
                posterTime.textContent = '状态码：' + res.status;
                return;
            }
            const data = await res.json();
            posterTitle.textContent = data.title || '活动宣传海报';
            posterTime.textContent = formatTimeRange(data.startTime, data.endTime);
            posterLocation.textContent = data.location ? ('地点：' + data.location) : '';
            posterDesc.textContent = data.description ? ('简介：' + data.description) : '';

            const signupValid = isSignupValid(data);
            posterStatus.textContent = signupValid ? '报名进行中，长按扫码报名' : '报名已失效';
            posterStatus.classList.toggle('expired', !signupValid);

            const registerUrl = `${window.location.origin}/register.html?activityId=${encodeURIComponent(activityId)}`;
            qrCodeImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(registerUrl)}`;
        } catch (e) {
            console.error(e);
            posterTitle.textContent = '活动信息加载失败';
            posterTime.textContent = '请稍后再试';
        }
    }

    function formatTimeRange(start, end) {
        if (!start && !end) return '时间未设置';
        const format = (val) => val ? val.toString().replace('T', ' ').substring(0, 16) : '--';
        return `时间：${format(start)} - ${format(end)}`;
    }

    function isSignupValid(activity) {
        if (!activity) return false;
        const normalizedStatus = normalizeStatus(activity.status);
        if (normalizedStatus && normalizedStatus !== 'OPEN') return false;
        if (activity.signupEndTime && new Date() > new Date(activity.signupEndTime)) return false;
        if (activity.endTime && new Date() > new Date(activity.endTime)) return false;
        return true;
    }
</script>
</body>
</html>
