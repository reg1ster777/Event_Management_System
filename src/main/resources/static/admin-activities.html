<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>管理员后台 - 活动管理</title>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background: #f5f5f5;
        }

        header {
            padding: 16px 32px;
            background: #1677ff;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        header .left {
            display: flex;
            flex-direction: column;
        }

        header .title {
            font-size: 20px;
            font-weight: 600;
        }

        header .subtitle {
            font-size: 13px;
            opacity: 0.9;
        }

        header .nav-links {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        header .nav-links a,
        header .nav-links button {
            color: #fff;
            font-size: 13px;
            text-decoration: none;
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.6);
            background: transparent;
            cursor: pointer;
        }

        header .nav-links a:hover,
        header .nav-links button:hover {
            background: rgba(0, 0, 0, 0.08);
        }

        header .nav-links button {
            line-height: 1.2;
        }

        header .admin-info {
            font-size: 13px;
            opacity: 0.9;
        }

        main {
            padding: 20px 32px 32px;
        }

        .layout {
            display: block;
        }

        .card {
            background: #fff;
            border-radius: 10px;
            padding: 16px 18px 18px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(0, 0, 0, 0.03);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .card-desc {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .toolbar .info {
            font-size: 12px;
            color: #777;
        }

        .filter-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .toggle-btn {
            border: 1px solid #1677ff;
            color: #1677ff;
            background: #fff;
            padding: 5px 12px;
            border-radius: 999px;
            cursor: pointer;
            font-size: 12px;
        }

        .toggle-btn.active {
            background: #1677ff;
            color: #fff;
        }

        .search-input {
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 12px;
        }

        .btn {
            display: inline-block;
            padding: 6px 12px;
            font-size: 13px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.15s ease;
            user-select: none;
        }

        .btn-primary {
            background: #1677ff;
            color: #fff;
        }

        .btn-primary:hover {
            background: #165fcc;
            box-shadow: 0 4px 10px rgba(22, 119, 255, 0.35);
        }

        .btn-outline {
            background: #fff;
            color: #1677ff;
            border: 1px solid #1677ff;
        }

        .btn-outline:hover {
            background: rgba(22, 119, 255, 0.06);
        }

        .btn-danger {
            background: #ff4d4f;
            color: #fff;
        }

        .btn-danger:hover {
            background: #d9363e;
        }

        .btn[disabled] {
            opacity: 0.45;
            cursor: not-allowed;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th, td {
            padding: 6px 8px;
            border-bottom: 1px solid #eee;
            text-align: left;
            vertical-align: middle;
        }

        th {
            background: #fafafa;
            font-weight: 600;
        }

        tr:hover {
            background: #fafafa;
        }

        .tag-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 12px;
        }

        .tag-status.unpublished {
            background: #f2f2f2;
            color: #7a7a7a;
            border: 1px solid #d9d9d9;
        }

        .tag-status.signing {
            background: #e7f9ef;
            color: #1f9d55;
            border: 1px solid #9fd8b5;
        }

        .tag-status.closed {
            background: #fff4e6;
            color: #d67a00;
            border: 1px solid #f1c48a;
        }

        .tag-status.finished {
            background: #ffecec;
            color: #d93025;
            border: 1px solid #f2b8b5;
        }

        .message {
            margin-top: 6px;
            font-size: 12px;
            min-height: 16px;
        }

        .message.error {
            color: #d93025;
        }

        .message.success {
            color: #0b9a42;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            box-sizing: border-box;
            padding: 6px 8px;
            font-size: 13px;
            border-radius: 6px;
            border: 1px solid #ccc;
            outline: none;
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #1677ff;
            box-shadow: 0 0 0 2px rgba(22, 119, 255, 0.15);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .hint {
            font-size: 11px;
            color: #999;
            margin-top: 2px;
        }

        .muted {
            color: #999;
            font-size: 12px;
        }

        /* ç”¨äºŽåªè¯»æ˜¾ç¤ºçš„åˆ›å»ºè€…ç”¨æˆ·åï¼Œä½¿ç”¨ç°è‰²è¡¨æ˜Žä¸å¯ä¿®æ”¹ */
        .readonly-field {
            color: #888;
            background: #f8f8f8;
        }

        /* 详情弹窗 */
        .modal-mask {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.35);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: #fff;
            border-radius: 10px;
            padding: 18px 20px;
            width: min(520px, 90vw);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.18);
            border: 1px solid #eee;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .modal-title {
            font-size: 16px;
            font-weight: 600;
        }

        .modal-close {
            border: none;
            background: transparent;
            font-size: 18px;
            cursor: pointer;
            color: #666;
        }

        .detail-list {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 13px;
            text-align: left;
        }

        .detail-list li {
            padding: 6px 0;
            border-bottom: 1px solid #f3f3f3;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .detail-key {
            color: #555;
            width: 120px;
            flex-shrink: 0;
        }

        .detail-value {
            color: #333;
            word-break: break-word;
            flex: 1;
        }
    </style>
</head>
<body>
<header>
    <div class="left">
        <div class="title">管理员后台 · 活动管理</div>
        <div class="subtitle">查看活动列表 · 创建新活动 · 管理活动状态</div>
    </div>
    <div class="nav-links">
        <span class="admin-info" id="header-admin-name">当前管理员：--</span>
        <button type="button" id="header-logout-btn">退出登录</button>
        <a href="/admin-create-activity.html">新建活动</a>
        <a href="/index.html">返回首页</a>
    </div>
</header>

<main>
    <div class="layout">
        <!-- 左：活动列表 -->
        <section class="card">
            <div class="card-title">活动列表</div>
            <div class="card-desc">
                这里展示当前所有活动信息，支持按状态查看、刷新列表。后续可扩展编辑、查看报名等功能。
            </div>

            <div class="toolbar">
                <div class="info" id="activities-summary">正在加载活动列表...</div>
                <div class="filter-actions">
                    <button class="toggle-btn" id="toggle-my-activities">我的活动</button>
                    <select id="filter-type" class="search-input" style="min-width:120px;">
                        <option value="">全部类型</option>
                        <option value="讲座">讲座</option>
                        <option value="宣讲会">宣讲会</option>
                        <option value="就业指导">就业指导</option>
                        <option value="其他">其他</option>
                    </select>
                    <select id="filter-status" class="search-input" style="min-width:120px;">
                        <option value="">全部状态</option>
                        <option value="DRAFT">未发布</option>
                        <option value="OPEN">报名中</option>
                        <option value="CLOSED">已截止</option>
                        <option value="FINISHED">已结束</option>
                    </select>
                    <input id="filter-start" class="search-input" type="datetime-local" style="min-width:160px;">
                    <input id="filter-end" class="search-input" type="datetime-local" style="min-width:160px;">
                    <input id="search-title" class="search-input" type="text" placeholder="按名称搜索">
                    <button class="btn btn-outline" id="search-btn">查询</button>
                    <button class="btn btn-outline" id="refresh-btn">刷新列表</button>
                </div>
            </div>

            <div style="overflow-x: auto;">
            <table>
                <thead>
                <tr>
                    <th>ID</th>
                    <th>活动名称</th>
                    <th>类型</th>
                    <th>时间</th>
                    <th>地点</th>
                    <th>状态</th>
                    <th>报名上限</th>
                    <th>已报名</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody id="activities-tbody">
                    <!-- JS 动态填充 -->
                    </tbody>
                </table>
            </div>

            <div id="list-message" class="message"></div>
        </section>

    </div>
</main>

<!-- 详情弹窗 -->
<div id="detail-modal-mask" class="modal-mask">
    <div class="modal" role="dialog" aria-modal="true">
        <div class="modal-header">
            <div class="modal-title">活动详情</div>
            <button class="modal-close" aria-label="关闭" onclick="closeDetailModal()">&times;</button>
        </div>
        <ul class="detail-list" id="detail-list">
            <li>正在加载...</li>
        </ul>
        <div id="detail-message" class="message"></div>
    </div>
</div>

<script>
    const activitiesTbody = document.getElementById('activities-tbody');
    const activitiesSummary = document.getElementById('activities-summary');
    const listMessage = document.getElementById('list-message');
    const refreshBtn = document.getElementById('refresh-btn');
    const detailModalMask = document.getElementById('detail-modal-mask');
    const detailList = document.getElementById('detail-list');
    const detailMessage = document.getElementById('detail-message');
    const headerAdminName = document.getElementById('header-admin-name');
    const headerLogoutBtn = document.getElementById('header-logout-btn');
    const toggleMyActivitiesBtn = document.getElementById('toggle-my-activities');
    const searchInput = document.getElementById('search-title');
    const searchBtn = document.getElementById('search-btn');
    const filterTypeSelect = document.getElementById('filter-type');
    const filterStatusSelect = document.getElementById('filter-status');
    const filterStartInput = document.getElementById('filter-start');
    const filterEndInput = document.getElementById('filter-end');

    const STATUS_TEXT_MAP = {
        DRAFT: '未发布',
        OPEN: '报名中',
        CLOSED: '已截止',
        FINISHED: '已结束',
        DELETED: '已删除'
    };
    const LEGACY_STATUS_TO_CODE = {
        '未发布': 'DRAFT',
        '报名中': 'OPEN',
        '已截止': 'CLOSED',
        '已结束': 'FINISHED',
        '已删除': 'DELETED'
    };

    // 登录态：当前管理员信息
    let currentUser = null;
    // 活动缓存用于筛选
    let allActivities = [];
    let onlyMine = false;
    let keyword = '';
    let filterType = '';
    let filterStatus = '';
    let filterStart = '';
    let filterEnd = '';

    // 尝试从 localStorage 中读取登录时保存的管理员信息
    function initCurrentUser() {
        const stored = localStorage.getItem('adminUser');
        if (stored) {
            try {
                currentUser = JSON.parse(stored);
            } catch (e) {
                console.error(e);
                currentUser = null;
            }
        }

        const isLoggedIn = !!currentUser;
        if (headerAdminName) {
            headerAdminName.textContent = isLoggedIn
                ? '当前管理员：' + (currentUser.username || '')
                : '当前管理员：未登录';
        }
        if (headerLogoutBtn) {
            if (isLoggedIn) {
                headerLogoutBtn.style.display = 'inline-block';
                headerLogoutBtn.onclick = () => {
                    localStorage.removeItem('adminUser');
                    window.location.href = '/login.html';
                };
            } else {
                headerLogoutBtn.style.display = 'none';
            }
        }
        if (!isLoggedIn && toggleMyActivitiesBtn) {
            toggleMyActivitiesBtn.disabled = true;
            toggleMyActivitiesBtn.title = '登录后可筛选“我的活动”';
        }
    }

    function showListMessage(text, type) {
        listMessage.textContent = text || '';
        listMessage.className = 'message';
        if (type === 'error') listMessage.classList.add('error');
        if (type === 'success') listMessage.classList.add('success');
    }

    function formatDateTime(dt) {
        if (!dt) return '';
        try {
            // 如果后端返回的是 ISO 字符串，简单截断到 分钟部分
            return dt.toString().replace('T', ' ').substring(0, 16);
        } catch (e) {
            return dt;
        }
    }

    function normalizeStatus(status) {
        if (!status) return '';
        if (STATUS_TEXT_MAP[status]) return status;
        return LEGACY_STATUS_TO_CODE[status] || status;
    }

    function getStatusLabel(status) {
        const normalized = normalizeStatus(status);
        return STATUS_TEXT_MAP[normalized] || normalized || '';
    }

    function renderStatusTag(status) {
        const normalized = normalizeStatus(status);
        let cls = 'unpublished';
        if (normalized === 'OPEN') cls = 'signing';
        else if (normalized === 'CLOSED') cls = 'closed';
        else if (normalized === 'FINISHED') cls = 'finished';

        return `<span class="tag-status ${cls}">${getStatusLabel(normalized)}</span>`;
    }

    function openDetailModal() {
        detailModalMask.style.display = 'flex';
    }

    function closeDetailModal() {
        detailModalMask.style.display = 'none';
        detailMessage.textContent = '';
        detailList.innerHTML = '';
    }

    function renderDetail(data) {
        const startEnd = formatDateTime(data.startTime) + ' ~ ' + formatDateTime(data.endTime);
        const signupEnd = formatDateTime(data.signupEndTime);
        const createdTime = formatDateTime(data.createdTime);
        const normalizedStatus = normalizeStatus(data.status);
        const now = new Date();
        let registerLink = '';
        let posterLink = '';
        const canSignUp = normalizedStatus === 'OPEN'
            && data.signupEndTime
            && now <= new Date(data.signupEndTime);
        if (canSignUp) {
            registerLink = `<a href="/register.html?activityId=${data.activityId ?? ''}" target="_blank">打开报名页</a>`;
            posterLink = `<a href="/poster.html?activityId=${data.activityId ?? ''}" target="_blank">查看海报</a>`;
        } else {
            const reason = normalizedStatus === 'OPEN'
                ? '报名已截止，链接关闭'
                : normalizedStatus === 'DRAFT'
                    ? '未开放报名'
                    : '报名已结束';
            const greyText = `<span style="color:#999;">${reason}</span>`;
            registerLink = greyText;
            posterLink = greyText;
        }

        detailList.innerHTML = `
            <li><span class="detail-key">ID</span><span class="detail-value">${data.activityId ?? ''}</span></li>
            <li><span class="detail-key">活动名称</span><span class="detail-value">${data.title || ''}</span></li>
            <li><span class="detail-key">类型</span><span class="detail-value">${data.type || ''}</span></li>
            <li><span class="detail-key">时间</span><span class="detail-value">${startEnd}</span></li>
            <li><span class="detail-key">地点</span><span class="detail-value">${data.location || ''}</span></li>
            <li><span class="detail-key">状态</span><span class="detail-value">${getStatusLabel(data.status)}</span></li>
            <li><span class="detail-key">报名截止</span><span class="detail-value">${signupEnd}</span></li>
            <li><span class="detail-key">报名上限</span><span class="detail-value">${data.maxParticipants ?? '不限'}</span></li>
            <li><span class="detail-key">已报名人数</span><span class="detail-value">${data.currentRegistrations ?? '加载中'}</span></li>
            <li><span class="detail-key">直播链接</span><span class="detail-value">${data.liveUrl ? `<a href="${data.liveUrl}" target="_blank">${data.liveUrl}</a>` : ''}</span></li>
            <li><span class="detail-key">附件链接</span><span class="detail-value">${data.attachmentUrl ? `<a href="${data.attachmentUrl}" target="_blank">${data.attachmentUrl}</a>` : ''}</span></li>
            <li><span class="detail-key">标签</span><span class="detail-value">${data.tags || ''}</span></li>
            <li><span class="detail-key">创建人</span><span class="detail-value">${data.createdByName || data.createdBy || ''}</span></li>
            <li><span class="detail-key">创建时间</span><span class="detail-value">${createdTime}</span></li>
            <li><span class="detail-key">简介</span><span class="detail-value">${data.description || ''}</span></li>
            <li><span class="detail-key">宣传海报</span><span class="detail-value">${posterLink}</span></li>
            <li><span class="detail-key">报名链接</span><span class="detail-value">${registerLink}</span></li>
        `;
    }

    async function viewActivityDetail(id) {
        openDetailModal();
        detailMessage.textContent = '';
        detailList.innerHTML = '<li>正在加载...</li>';

        try {
            const res = await fetch('/activities/' + id, { method: 'GET' });
            if (!res.ok) {
                detailMessage.textContent = '加载详情失败，状态码：' + res.status;
                return;
            }
            const data = await res.json();
            renderDetail(data || {});
        } catch (e) {
            console.error(e);
            detailMessage.textContent = '请求详情失败，请检查网络或后端服务。';
        }
    }

    function renderActivities(list) {
        if (!Array.isArray(list) || list.length === 0) {
        activitiesSummary.textContent = '当前暂无活动记录。';
        activitiesTbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#999;">暂无活动，请点击右上角“新建活动”。</td></tr>';
        return;
    }

        activitiesSummary.textContent = '共 ' + list.length + ' 条活动。';
        const myUserId = currentUser && currentUser.userId != null ? Number(currentUser.userId) : null;

        const rows = list.map(item => {
            const startEnd = formatDateTime(item.startTime) + ' ~ ' + formatDateTime(item.endTime);
            const statusHtml = renderStatusTag(item.status);
            const creatorId = item.createdBy != null ? Number(item.createdBy) : null;
            const isOwner = myUserId != null && creatorId != null && myUserId === creatorId;
            const deleteBtn = isOwner
                ? `<button class="btn btn-danger" onclick="deleteActivity(${item.activityId}, ${item.createdBy ?? 'null'})">删除</button>`
                : '';
            const publishBtn = (isOwner && item.status === 'DRAFT')
                ? `<button class="btn btn-primary" onclick="publishActivity(${item.activityId})">发布</button>`
                : '';
            const editBtn = isOwner
                ? `<button class="btn btn-outline" onclick="editActivity(${item.activityId})">编辑</button>`
                : '';
            const currentCount = item.currentRegistrations != null ? item.currentRegistrations : 0;
            const maxCount = item.maxParticipants != null ? item.maxParticipants : '';

            return `
                <tr>
                    <td>${item.activityId}</td>
                    <td>${item.title || ''}</td>
                    <td>${item.type || ''}</td>
                    <td>${startEnd}</td>
                    <td>${item.location || ''}</td>
                    <td>${statusHtml}</td>
                    <td>${maxCount}</td>
                    <td>${currentCount}</td>
                    <td>
                        <button class="btn btn-outline" onclick="viewActivityDetail(${item.activityId})">详情</button>
                        ${editBtn}
                        ${publishBtn}
                        ${deleteBtn}
                    </td>
                </tr>
            `;
        }).join('');

        activitiesTbody.innerHTML = rows;
    }

    function applyFilters() {
        let filtered = Array.from(allActivities);
        const myUserId = currentUser && currentUser.userId != null ? Number(currentUser.userId) : null;
        if (onlyMine && myUserId != null) {
            filtered = filtered.filter(item => item.createdBy != null && Number(item.createdBy) === myUserId);
        }
        const kw = keyword.trim().toLowerCase();
        if (kw) {
            filtered = filtered.filter(item => {
                const title = (item.title || '').toLowerCase();
                const tags = (item.tags || '').toLowerCase();
                return title.includes(kw) || tags.includes(kw);
            });
        }
        if (filterType) {
            filtered = filtered.filter(item => item.type === filterType);
        }
        if (filterStatus) {
            filtered = filtered.filter(item => item.status === filterStatus);
        }
        if (filterStart) {
            const startDate = new Date(filterStart);
            filtered = filtered.filter(item => item.startTime && new Date(item.startTime) >= startDate);
        }
        if (filterEnd) {
            const endDate = new Date(filterEnd);
            filtered = filtered.filter(item => item.endTime && new Date(item.endTime) <= endDate);
        }
        renderActivities(filtered);
    }

    async function loadActivities() {
        activitiesSummary.textContent = '正在加载活动列表...';
        showListMessage('', '');
        activitiesTbody.innerHTML = '';

        try {
            const res = await fetch('/activities', { method: 'GET' });
            if (!res.ok) {
                activitiesSummary.textContent = '加载失败，状态码：' + res.status;
                showListMessage('无法获取活动列表，请检查后端接口 /activities 是否正常。', 'error');
                return;
            }

            const data = await res.json();
            allActivities = Array.isArray(data)
                ? data.map(item => ({ ...item, status: normalizeStatus(item.status) }))
                : [];
            if (allActivities.length === 0) {
                activitiesSummary.textContent = '当前暂无活动记录。';
                activitiesTbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#999;">暂无活动，请在右侧创建新活动。</td></tr>';
                return;
            }
            applyFilters();
        } catch (e) {
            console.error(e);
            activitiesSummary.textContent = '加载失败，请检查网络或后端服务。';
            showListMessage('调用 /activities 接口失败，请确认后端已启动、数据库连接正常。', 'error');
        }
    }

    async function deleteActivity(id, creatorId) {
        const myUserId = currentUser && currentUser.userId != null ? Number(currentUser.userId) : null;
        const ownerId = creatorId != null ? Number(creatorId) : null;
        if (myUserId == null || ownerId == null || myUserId !== ownerId) {
            alert('仅允许删除自己创建的活动。');
            return;
        }
        if (!confirm('确认删除活动 ID=' + id + ' 吗？此操作不可恢复。')) return;

        try {
            const res = await fetch(`/activities/${id}?requesterId=${encodeURIComponent(myUserId)}`, {
                method: 'DELETE'
            });

            if (res.ok) {
                showListMessage('删除成功。', 'success');
                await loadActivities();
            } else {
                showListMessage('删除失败，状态码：' + res.status, 'error');
            }
        } catch (e) {
            console.error(e);
            showListMessage('删除请求失败，请检查网络或后端日志。', 'error');
        }
    }

    async function publishActivity(id) {
        if (!allActivities || !Array.isArray(allActivities)) return;
        const myUserId = currentUser && currentUser.userId != null ? Number(currentUser.userId) : null;
        const target = allActivities.find(a => a.activityId === id);
        if (!target) return;
        if (myUserId == null || target.createdBy == null || Number(target.createdBy) !== myUserId) {
            alert('仅允许发布自己创建的活动。');
            return;
        }
        if (!confirm('确认将该活动发布为“报名中”状态？')) return;

        const payload = {
            ...target,
            status: 'OPEN'
        };

        try {
            const res = await fetch(`/activities/${id}?requesterId=${encodeURIComponent(myUserId)}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (res.ok) {
                showListMessage('发布成功。', 'success');
                await loadActivities();
            } else {
                const text = await res.text();
                showListMessage('发布失败，状态码：' + res.status + '，详情：' + text, 'error');
            }
        } catch (e) {
            console.error(e);
            showListMessage('发布请求失败，请检查网络或后端日志。', 'error');
        }
    }

    function editActivity(id) {
        window.location.href = `/admin-create-activity.html?activityId=${encodeURIComponent(id)}`;
    }

    refreshBtn.addEventListener('click', loadActivities);
    detailModalMask.addEventListener('click', (e) => {
        if (e.target === detailModalMask) closeDetailModal();
    });
    toggleMyActivitiesBtn?.addEventListener('click', () => {
        onlyMine = !onlyMine;
        toggleMyActivitiesBtn.classList.toggle('active', onlyMine);
        applyFilters();
    });
    searchBtn?.addEventListener('click', () => {
        keyword = searchInput.value || '';
        applyFilters();
    });
    searchInput?.addEventListener('keyup', (e) => {
        if (e.key === 'Enter') {
            keyword = searchInput.value || '';
            applyFilters();
        }
    });
    filterTypeSelect?.addEventListener('change', () => {
        filterType = filterTypeSelect.value || '';
        applyFilters();
    });
    filterStatusSelect?.addEventListener('change', () => {
        filterStatus = filterStatusSelect.value || '';
        applyFilters();
    });
    filterStartInput?.addEventListener('change', () => {
        filterStart = filterStartInput.value || '';
        applyFilters();
    });
    filterEndInput?.addEventListener('change', () => {
        filterEnd = filterEndInput.value || '';
        applyFilters();
    });

    // 先初始化当前登录管理员，再加载活动列表
    initCurrentUser();
    loadActivities();

</script>
</body>
</html>
