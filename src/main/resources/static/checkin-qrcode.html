<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>签到二维码</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            margin: 0;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #4f46e5 0%, #9333ea 100%);
            padding: 20px;
        }
        .panel {
            width: min(440px, 95vw);
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.35);
            padding: 28px;
        }
        h1 {
            margin: 0;
            font-size: 22px;
            text-align: center;
            color: #1f2d3d;
        }
        .info {
            margin: 18px 0;
            padding: 16px;
            border-radius: 12px;
            background: #f5f7fb;
            color: #333;
            line-height: 1.6;
            font-size: 14px;
        }
        .info strong {
            color: #2a5298;
        }
        .qr-box {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }
        #qr-image {
            width: 260px;
            height: 260px;
            background: #f0f2f5;
            border-radius: 16px;
            padding: 14px;
            object-fit: contain;
            box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.08);
        }
        .tip {
            font-size: 13px;
            color: #666;
            text-align: center;
        }
        .expired {
            text-align: center;
            color: #999;
            margin-top: 16px;
            font-size: 15px;
        }
        .actions {
            margin-top: 16px;
            display: flex;
            gap: 12px;
        }
        button {
            flex: 1;
            border: none;
            border-radius: 10px;
            padding: 12px;
            font-size: 14px;
            cursor: pointer;
            background: linear-gradient(135deg, #4f46e5, #9333ea);
            color: #fff;
            transition: transform 0.2s ease;
        }
        button.secondary {
            background: #fff;
            color: #4f46e5;
            border: 1px solid #4f46e5;
        }
        button:active {
            transform: translateY(1px);
        }
        .error {
            text-align: center;
            color: #c53030;
            padding: 20px 0;
        }
    </style>
</head>
<body>
<div class="panel">
    <h1 id="title">签到二维码</h1>
    <div id="info" class="info">正在加载活动信息...</div>
    <div class="qr-box" id="qr-box" style="display:none;">
        <img id="qr-image" alt="签到二维码">
    </div>
    <div class="error" id="error" style="display:none;"></div>
    <div class="expired" id="expired" style="display:none;">活动已结束</div>
    <div class="actions">
        <button id="refresh-btn">刷新二维码</button>
        <button id="back-btn" class="secondary">返回活动列表</button>
    </div>
</div>

<script>
    const params = new URLSearchParams(window.location.search);
    const activityId = params.get('activityId');
    const infoEl = document.getElementById('info');
    const expiredEl = document.getElementById('expired');
    const qrBox = document.getElementById('qr-box');
    const qrImg = document.getElementById('qr-image');
    const titleEl = document.getElementById('title');
    const errorEl = document.getElementById('error');
    const refreshBtn = document.getElementById('refresh-btn');
    const backBtn = document.getElementById('back-btn');

    const REFRESH_INTERVAL = 10000;
    let refreshTimer = null;
    let activityData = null;

    if (!activityId) {
        showError('缺少活动ID，请从后台入口打开此页面。');
        disableActions();
    } else {
        loadActivity();
        refreshQRCode();
    }

    refreshBtn.addEventListener('click', refreshQRCode);
    backBtn.addEventListener('click', () => window.location.href = '/admin-activities.html');

    async function loadActivity() {
        try {
            const res = await fetch('/activities/' + activityId);
            if (!res.ok) throw new Error('活动不存在');
            const data = await res.json();
            activityData = data;
            titleEl.textContent = (data.title || '活动') + ' - 签到二维码';
            infoEl.innerHTML =
                '<div><strong>活动名称：</strong>' + (data.title || '') + '</div>' +
                '<div><strong>时间：</strong>' + formatDateTime(data.startTime) + ' 至 ' + formatDateTime(data.endTime) + '</div>' +
                '<div><strong>地点：</strong>' + (data.location || '待定') + '</div>' +
                '<div><strong>签到有效期：</strong>' + formatDateTime(data.startTime) + ' - ' + formatDateTime(data.endTime) + '</div>';
            if (isExpired()) {
                showExpiredState();
            } else {
                expiredEl.style.display = 'none';
                refreshBtn.disabled = false;
            }
        } catch (e) {
            showError('加载活动失败：' + e.message);
        }
    }

    function refreshQRCode() {
        if (!activityId || isExpired()) {
            showExpiredState();
            return;
        }
        const baseUrl = window.location.origin;
        const qrUrl = `/api/poster/qrcode/checkin/${activityId}?baseUrl=${encodeURIComponent(baseUrl)}&ts=${Date.now()}`;
        qrImg.src = qrUrl;
        qrBox.style.display = 'flex';
        errorEl.style.display = 'none';
        scheduleAutoRefresh();
    }

    function showError(msg) {
        errorEl.textContent = msg;
        errorEl.style.display = 'block';
        qrBox.style.display = 'none';
        clearAutoRefresh();
    }

    function disableActions() {
        refreshBtn.disabled = true;
        backBtn.disabled = true;
        clearAutoRefresh();
    }

    function isExpired() {
        if (!activityData || !activityData.endTime) return false;
        return new Date() > new Date(activityData.endTime);
    }

    function showExpiredState() {
        qrBox.style.display = 'none';
        expiredEl.style.display = 'block';
        refreshBtn.disabled = true;
        clearAutoRefresh();
    }

    function formatDateTime(value) {
        if (!value) return '-';
        return value.toString().replace('T', ' ').substring(0, 16);
    }

    function scheduleAutoRefresh() {
        clearAutoRefresh();
        refreshTimer = setTimeout(() => refreshQRCode(false), REFRESH_INTERVAL);
    }

    function clearAutoRefresh() {
        if (refreshTimer) {
            clearTimeout(refreshTimer);
            refreshTimer = null;
        }
    }
</script>
</body>
</html>
